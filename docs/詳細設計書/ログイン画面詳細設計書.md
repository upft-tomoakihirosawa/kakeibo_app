# ログイン画面詳細設計書

---

## 1. ドキュメント管理

- 文書名: ログイン画面詳細設計書
- 作成者: 廣澤
- 作成日: 2025-05-16

---

## 2. 画面概要

ログイン画面は、家計簿アプリへのユーザー認証を担う重要なエントリーポイントです。メールアドレスとパスワードによる標準的な認証方式に加え、GoogleやApple等のSNSアカウントによるシングルサインオンを提供します。また、パスワードを忘れたユーザー向けのリセット機能や、新規ユーザー登録画面への誘導も行います。Flutterでの実装とRiverpodを用いた状態管理により、シームレスな認証フローとエラーハンドリングを実現します。

---

## 3. 画面レイアウト構成

画面レイアウトの詳細は [ログイン画面レイアウト](/Users/tomoaki.hirosawa/Documents/develop/kakeibo-app/doc/詳細設計書/画面レイアウト/ログイン画面.html) を参照してください。

### 3.1 画面構成要素

| コンポーネント | 説明 | 実装クラス |
|--------------|------|----------|
| アプリロゴ | アプリのロゴと名称、キャッチフレーズを表示 | `LoginScreen` |
| エラーメッセージ | 認証エラー発生時に表示されるメッセージ | `LoginScreen` |
| ログインフォーム | メールアドレスとパスワードの入力フィールド | `LoginScreen` |
| パスワードリセットリンク | パスワードリセット画面への遷移リンク | `LoginScreen` |
| ログインボタン | メールパスワード認証のためのボタン | `LoginScreen` |
| SNSログインボタン | GoogleとAppleのサインイン用ボタン | `LoginScreen` |
| 新規登録リンク | ユーザー登録画面への遷移リンク | `LoginScreen` |

### 3.2 入力項目とバリデーション

#### メールアドレスフィールド

- **必須項目**: はい
- **入力形式**: メールアドレス形式（正規表現による検証）
- **バリデーションルール**:
  - 空でないこと
  - メールアドレス形式であること

#### パスワードフィールド

- **必須項目**: はい
- **入力形式**: 非表示テキスト（表示切替可能）
- **バリデーションルール**:
  - 空でないこと
  - 8文字以上であること

---

## 4. クラス設計

ログイン画面の実装に関わる主要クラスは以下の通りです。詳細な実装はリンク先のクラス定義ドキュメントを参照してください。

### 4.1 画面クラス

- [LoginScreen](/Users/tomoaki.hirosawa/Documents/develop/kakeibo-app/doc/詳細設計書/クラス定義/LoginScreen.md) - ログイン画面のUIとユーザーインタラクションを実装

### 4.2 状態管理クラス

- [AuthNotifier](/Users/tomoaki.hirosawa/Documents/develop/kakeibo-app/doc/詳細設計書/クラス定義/AuthNotifier.md) - 認証状態と認証処理を管理するStateNotifier

---

## 5. 画面遷移

| イベント | 遷移先 | 条件 |
|---------|--------|------|
| ログイン成功 | ホーム画面 (`/home`) | メールパスワード認証またはSNS認証が成功 |
| 「パスワードをお忘れですか？」クリック | パスワードリセット画面 (`/password-reset`) | - |
| 「新規登録」クリック | ユーザー登録画面 (`/register`) | - |

---

## 6. エラーハンドリング

### 6.1 エラーシナリオと対応方針

| エラーシナリオ | 対応方針 | 実装方法 |
|--------------|---------|---------|
| ネットワーク接続の喪失 | オフラインモードでの対応とリトライ機構 | `ConnectivityResult`の監視とリトライロジックの実装 |
| メールアドレス/パスワードの不一致 | 明確なエラーメッセージと再入力の誘導 | Firebase Authのエラーコードに基づいた適切なエラーメッセージ表示 |
| アカウントの無効化/停止 | サポートへの連絡方法の提示 | アカウント状態に応じたエラー処理とサポート情報の表示 |
| SNS認証の連携解除 | 代替認証手段の提案 | 複数認証方法の提供とエラー発生時の誘導 |
| 多数のログイン試行と一時的ブロック | クールダウン期間の説明とパスワードリセットの提案 | Firebaseの`too-many-requests`エラーに対する専用ハンドリング |

### 6.2 エラーメッセージのローカライズ

エラーメッセージは、`_formatErrorMessage`メソッドを通して、技術的なエラーコードからユーザーフレンドリーな日本語メッセージに変換されます。Firebase Authのエラーコードと対応する日本語メッセージのマッピングを実装します。

---

## 7. セキュリティとユーザビリティ考慮事項

### 7.1 セキュリティ考慮

1. **強力なパスワード要件の実装**
   - 最低8文字以上を強制
   - 英字と数字を含む複雑なパスワードを推奨
   - 推測されやすいパスワード（123456など）の拒否

2. **認証失敗への対応**
   - 連続ログイン失敗時の一時的なアカウントロック
   - 不正アクセス試行の検知と緩和策
   - ユーザーへの通知メカニズム

3. **セッション管理**
   - 適切な認証トークンの有効期限設定
   - 定期的な再認証の実施
   - 複数デバイスでのログイン管理

4. **デバイス固有の対策**
   - モバイルデバイスでの生体認証（Touch ID / Face ID）サポート
   - デバイス認証情報の安全な保存
   - デバイスが盗難された場合のリモートログアウト機能

### 7.2 ユーザビリティ向上

1. **自動ログイン機能**
   - 前回のセッション情報を保存し、再認証の負担を軽減
   - アプリ起動時の認証状態チェック実装

2. **入力支援**
   - メールアドレスの自動保存/補完
   - パスワードマネージャーとの連携
   - デバイスキーボードの最適化

3. **適応型UI**
   - 異なる画面サイズへの最適化
   - ダークモード対応
   - アクセシビリティ機能のサポート（テキストサイズ調整など）

---

## 8. テスト計画

### 8.1 UIテスト

- ログインフォームのバリデーション動作
- エラーメッセージの表示と非表示
- パスワード表示切り替え機能
- 画面遷移の正確性
- ローディングインジケータの表示

### 8.2 ロジックテスト

- 認証処理の成功・失敗シナリオ
- エラーハンドリングの網羅性
- 状態管理の整合性
- オフライン時の動作

詳細なテストケースは [LoginScreenのテスト](/Users/tomoaki.hirosawa/Documents/develop/kakeibo-app/doc/詳細設計書/クラス定義/LoginScreen.md#6.1-LoginScreenのウィジェットテスト) および [AuthNotifierのテスト](/Users/tomoaki.hirosawa/Documents/develop/kakeibo-app/doc/詳細設計書/クラス定義/AuthNotifier.md#AuthNotifierのユニットテスト) を参照してください。

---

## 9. 変更履歴

| 日付       | 変更内容               | 担当者 |
| ---------- | ---------------------- | ------ |
| 2025-05-16 | 初版リリース           | 廣澤   |
