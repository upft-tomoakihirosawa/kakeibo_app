# CSVエクスポートインポート機能 設計書

---

## 1. ドキュメント管理

- **文書名**: CSVエクスポートインポート機能 設計書  
- **作成者**: 廣澤  
- **作成日**: 2025-05-16  

---

## 2. 画面概要

- **画面名称**: CSVエクスポート/インポート画面  
- **目的・概要**:  
  ユーザーが家計簿アプリ内の収支データをCSV形式でエクスポートし、または他のCSVファイルからデータをインポートするための画面です。  
  ・エクスポート機能により、ユーザーは現在の家計簿データを簡単にローカル保存や他システムでの利用のために取り出すことができます。  
  ・インポート機能により、ユーザーはバックアップデータや外部から取得したCSVファイルをアプリに取り込むことができ、データの移行や更新が容易になります。

---

## 3. UIコンポーネント詳細

### コンポーネント一覧

| コンポーネント名           | 属性         | 機能・動作                                                       | 導出元               | 導出元項目               | 備考                                     |
| -------------------------- | ------------ | ---------------------------------------------------------------- | -------------------- | ------------------------ | ---------------------------------------- |
| タブ切り替えコンポーネント | ボタン/タブ  | 「エクスポート」「インポート」タブを切替え、表示する画面領域を変更  | －                   | －                       | 初期表示は「エクスポート」タブ            |
| CSVエクスポートボタン      | ボタン       | クリック時、エクスポートAPIを呼び出しCSVファイル生成を実行、結果URLを取得 | CSVエクスポートAPI   | exportFileUrl            | API呼び出し中は非活性化する処理を実行      |
| ダウンロードリンク表示エリア | リンク/テキスト | エクスポート成功後、生成されたCSVファイルのダウンロードURLを表示        | CSVエクスポートAPI   | exportFileUrl            | URL表示時はクリックでダウンロード開始      |
| CSVファイル選択ボタン      | ボタン       | ファイル選択ダイアログを起動し、ユーザーがCSVファイルを選択           | －                   | －                       | インポートタブ内に配置                     |
| 選択ファイル表示フィールド  | テキスト表示 | 選択されたCSVファイルの名称を表示                                   | CSVファイル選択操作   | fileName                 | ファイル未選択時は「ファイル未選択」と表示   |
| CSVインポートボタン        | ボタン       | クリック時、選択されたCSVファイルをアップロードし、インポートAPIを呼出    | CSVインポートAPI     | importResult             | アップロード中は進捗表示とエラー処理を実施    |
| インポート結果表示ラベル    | テキスト     | インポート実行後の成功／失敗のメッセージを表示                        | CSVインポートAPI     | importResultMessage      | メッセージの内容により色分け（例：赤＝失敗） |

| 読込中プログレスバー       | プログレスバー | API呼出し中の状態を表示                                           | 各API呼出し時         | －                       | エクスポート、インポート共通                |

---

## 4. 入力・出力項目

### 入力項目の詳細

画面表示時に呼び出し元から受け取るデータは以下とする。

- 特に無し

### 出力項目の詳細

画面終了時に呼び出し元に返すデータは以下とする。

- 特に無し

---

## 5. イベント・アクション仕様

- **画面表示開始時の初期処理**  
  ・画面表示時に初期状態として「エクスポート」タブをアクティブに設定する。  
  ・各コンポーネント（ダウンロードリンク、インポート結果表示ラベル）は非表示またはリセット状態にする。  
  ・各API呼出し前に読込中プログレスバーを表示し、呼出し完了後に非表示とする。

- **タブ切り替え時の処理**  
  ・ユーザーがタブを切り替えた場合、該当タブに対応するUIコンポーネント群（エクスポート用 or インポート用）を表示する。  
  ・切替時に前回の結果表示やエラーメッセージはリセットする。

- **CSVエクスポート実行時のアクション**  
  ・ユーザーが【CSVエクスポートボタン】をクリックすると、バックエンドのCSVエクスポートAPI（例：/api/csv/export）を呼び出す。  
  ・API呼出し中は【読込中プログレスバー】を表示し、ボタンの多重クリック防止のため非活性化する。  
  ・APIから成功レスポンス（生成されたCSVファイルのURL）を受け取り、【ダウンロードリンク表示エリア】にURLを表示する。  
  ・エラー発生時は、該当のエラーコードに基づいたエラーメッセージを【インポート結果表示ラベル】で表示する。

- **CSVファイル選択およびインポート実行時のアクション**  
  ・【CSVファイル選択ボタン】をクリックすると、システムのファイル選択ダイアログを起動する。  
  ・選択したファイルの名称が【選択ファイル表示フィールド】に反映される。  
  ・【CSVインポートボタン】をクリック時、選択ファイルの有無とファイル形式（拡張子が.csvであること）をバリデーションする。  
  ・バリデーション成功後、バックエンドのCSVインポートAPI（例：/api/csv/import）へファイルデータを送信する。  
  ・送信中は【読込中プログレスバー】を表示し、並行した操作を防止する。  
  ・APIのレスポンスにより、成功または失敗メッセージを【インポート結果表示ラベル】に表示する。  
  ・失敗時はエラーハンドリングに基づき、適切なエラーメッセージと対処方法をユーザーに示す。

- **画面終了時の処理**  
  ・特に保持すべきデータは無いため、ユーザーが戻るまたは画面閉鎖時に各コンポーネントの状態がリセットされるのみ。

---

## 6. バリデーションとエラーハンドリング

### バリデーションルール

| 項目名       | 制約条件                                | チェック方法                             | 備考                                  |
| ------------ | --------------------------------------- | ---------------------------------------- | ------------------------------------- |
| CSVファイル  | 拡張子が「.csv」であること、必須入力      | ファイル名の正規表現チェックおよびMIMEタイプ検証 | ファイル内容のフォーマットチェックは別途実施 |

### エラーハンドリング

| エラーコード | エラーメッセージ                                 | 対処方法                                               |
| ------------ | ------------------------------------------------ | ------------------------------------------------------ |
| ERR_CSV001   | CSVファイルが選択されていません                 | CSVファイルを選択し、再度インポートボタンを押してください |
| ERR_CSV002   | ファイル形式が不正です                           | CSVファイル形式のファイルを選択してください            |
| ERR_API001   | CSVエクスポートに失敗しました                    | ネットワーク接続を確認の上、再試行してください          |
| ERR_API002   | CSVインポートに失敗しました                      | ファイル内容を確認し、再度インポートを実行してください      |

---

## 7. 補足情報

- **外部連携・API**:  
  ・CSVエクスポートAPI (例：GET /api/csv/export)：家計簿データをCSV形式に変換し、ダウンロード用URLを返す。  
  ・CSVインポートAPI (例：POST /api/csv/import)：アップロードされたCSVファイルの内容を解析し、家計簿データとしてDBに登録する。  

- **使用DB**: 家計簿データ保存に、Firebase Firestore または MongoDB を利用  
- **参考資料・用語集**:  
  ・家計簿アプリ 要件定義書  
  ・デザインガイドライン及びUIコンポーネント標準仕様書

---

## 8. 課題、検討、不明事項

- CSVインポート時、重複データや既存データとの統合ルールが未確定のため、取り込みロジックの詳細設計が必要  
- 大容量のCSVファイルに対するアップロードおよび解析処理のパフォーマンス検証が不足している  
- エクスポートファイルのセキュリティ（ダウンロード用の一時URL発行、期限設定）の実装方法について更なる検討が必要  
- インポート実行時のUIフィードバック（エラー発生時のリトライ機能等）のユーザー体験向上策について議論の余地あり

---

## 9. 変更履歴

| 日付       | 変更内容                          | 担当者 |
| ---------- | --------------------------------- | ------ |
| 2025-05-16 | 初版リリース                      | 廣澤  |