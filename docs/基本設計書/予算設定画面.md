# 予算設定画面 設計書

---

## 1. ドキュメント管理

- 文書名: 予算設定画面 設計書  
- 作成者: 廣澤  
- 作成日: 2025-05-16  

---

## 2. 画面概要

- 画面名称: 予算設定画面  
- 目的・概要:  
  ユーザーが月ごとに家計の予算を設定・更新できる画面です。既に設定済みの予算がある場合は表示され、ユーザーは数値を入力または修正して保存できます。また、現時点での支出状況に基づいた予算達成度を進捗バーで視覚的に確認できるため、適切な家計管理をサポートします。

---

## 3. UIコンポーネント詳細

### コンポーネント一覧

| コンポーネント名         | 属性         | 機能・動作                                                         | 導出元                     | 導出元項目           | 備考                                  |
| ------------------------ | ------------ | ------------------------------------------------------------------ | -------------------------- | -------------------- | ------------------------------------- |
| 画面タイトルラベル       | ラベル       | 画面上部に「予算設定」と固定文字列でタイトルを表示                    | 定数／画面固定値           | タイトル             | 変更不要                              |
| 説明ラベル               | ラベル       | 「今月の予算を設定してください」と説明文を表示                        | 定数／画面固定値           | 説明テキスト         | ユーザーに入力内容の意図を伝える         |
| 月選択スピナー           | スピナー     | ユーザーが対象の月を選択。選択変更時に該当月の予算情報を再取得           | システム／予算設定API      | 対象月               | 初期値はシステム日付の月               |
| 予算入力フィールド       | テキスト入力 | ユーザーが設定する予算額（数値）の入力フィールド                       | 予算設定API／BudgetDB      | budgetAmount         | 入力は半角数字。過去データがあれば初期値として表示  |
| 予算達成進捗バー         | プログレスバー | 現在の支出と設定予算から算出した達成度（％）を視覚的に表示               | 予算計算API／集計DB        | usedPercentage       | 支出合計と予算額から算出                |
| 保存ボタン               | ボタン       | 入力された予算情報をAPI経由で保存。保存後は確認メッセージを表示し前画面へ遷移 | －                         | －                   | バリデーション通過後にアクション実行       |
| キャンセルボタン         | ボタン       | 入力内容を破棄し、前画面へ戻る                                          | －                         | －                   | ユーザー操作による画面遷移                |

---

## 4. 入力・出力項目

### 入力項目の詳細

画面表示時に呼び出し元から受け取るデータ項目は以下とする。

| 項目名 | 入力形式 | 入力制約 | エラーメッセージ例 |
| ------ | -------- | -------- | ------------------ |
| 特に無し | - | - | - |

※ ただし、ログイン済みのユーザー情報（ユーザーID等）はセッション管理により内部的に扱う。

### 出力項目の詳細

画面終了時に呼び出し元に返すデータ項目は以下とする。

| 項目名       | 内容                                  |
| ------------ | ------------------------------------- |
| 設定済み予算額 | ユーザーが設定した当月の予算額（数値）         |
| メッセージ   | 保存成功時やキャンセル時などのフィードバックメッセージ |

---

## 5. イベント・アクション仕様

■ 画面表示時（初期処理）  
1. ユーザーのセッション情報からユーザーIDを取得する。  
2. システム日付から初期の対象月を決定し、月選択スピナーに初期選択値として設定する。  
3. 予算設定APIを呼び出し、対象月の既存予算（budgetAmount）と達成状況（usedPercentage）を取得。  
4. 取得結果をもとに、予算入力フィールドに数値を表示、予算達成進捗バーを更新する。  
5. 人為的なネットワーク遅延対応として、ロード中インジケーター（必要に応じて）を表示する。

■ 月選択スピナー変更時  
1. ユーザーが別の月を選択すると、対象月の予算情報を再取得する。  
2. 取得できた場合、予算入力フィールドと進捗バーの表示を更新。  
3. エラーが発生した場合は、適切なエラーメッセージをユーザーに通知する。

■ 保存ボタン押下時  
1. ユーザーが入力した予算額のバリデーションチェックを実施する。  
2. バリデーション通過後、予算設定APIに対してPOST（またはPUT）リクエストを送信し、データベースへ保存する。  
3. APIレスポンスにより、保存成功の場合は成功メッセージを表示し、前画面又は一覧へ遷移する。  
4. APIエラーの場合、エラーメッセージを表示し再入力を促す。

■ キャンセルボタン押下時  
1. 編集内容を破棄し、確認ダイアログを（必要に応じて）表示する。  
2. ユーザーの意志を確認後、前画面へ遷移する。

■ 画面終了時（終了処理）  
1. ユーザーの最新設定（予算額）を出力項目として呼び出し元に返却する。  
2. 画面で行った変更内容がキャッシュ等に保存されている場合は、適切にクリアする。

---

## 6. バリデーションとエラーハンドリング

■ バリデーションルール

| 項目名     | 制約条件                                     | チェック方法                       | 備考                                          |
| ---------- | -------------------------------------------- | ---------------------------------- | --------------------------------------------- |
| 予算入力   | ・必須<br>・半角数字のみ<br>・0以上の整数     | ・リアルタイムの入力チェック<br>・送信時に正規表現（例: /^[1-9]＼d*$/）によるチェック | 0の場合の扱い（無料、または入力エラー）を明確化すること |

■ エラーハンドリング

| エラーコード       | エラーメッセージ                                           | 対処方法                                |
| ------------------ | ---------------------------------------------------------- | --------------------------------------- |
| ERR_BUDGET_FORMAT  | 予算は正の整数の数値で入力してください                     | 入力値を修正し、再度保存を試みる         |
| ERR_BUDGET_SAVE    | 予算の保存中にエラーが発生しました。再度お試しください         | ユーザーにエラー通知し、再送信または後日再試行する  |
| ERR_API_TIMEOUT    | 通信がタイムアウトしました。ネットワークを確認してください      | 再送信ボタンの表示または自動再試行           |

※ APIエラー、DBエラーについては、各エラー発生時に詳細ログを記録し、画面上ではユーザーに簡潔なエラーメッセージを表示する。

---

## 7. 補足情報

■ 外部連携・API  
- 予算設定API  
  ・ GET /user/{userId}/budget?month={selectedMonth}  
    → 対象月の既存予算、進捗状況（usedPercentage）を取得  
  ・ POST /user/{userId}/budget または PUT /user/{userId}/budget  
    → 予算額（budgetAmount）を更新または新規作成  
- 予算計算API（または内部集計処理）  
  → ユーザーの支出データから、達成率（usedPercentage）を算出  

■ DB連携  
- Firebase Firestore または MongoDB を利用し、BudgetDB内に{ userId, month, budgetAmount, 更新日時 }のレコードを管理

■ 参考資料・用語集  
- 「家計簿アプリ 要件定義書 (2025/05)」  
- UIデザインガイドライン（シンプル、直感的操作を重視）  

---

## 8. 課題、検討、不明事項

■ 課題・検討事項  
- 月選択により対象月の予算情報が未登録の場合、新規登録と更新の判定をどのタイミングで行うか検討が必要  
- 予算達成進捗バーは、支出の集計処理と連動するが、集計のリアルタイム性や更新タイミングの仕様を詰める必要あり  
- 数値入力フィールドにおける入力エラーチェック（例えば、空白や0入力時の挙動）の詳細仕様について検討すべき  
- API及びDB連携で、ネットワーク遅延やタイムアウト時のユーザー体験（UX）の改善について、リトライ処理やインジケーターの表示仕様を検討する

■ 不明事項  
- 複数通貨対応の要否（現状は単一通貨を前提としているが、将来拡張として検討する余地あり）  
- 画面遷移後の戻り値（出力項目）の具体的な受け渡し方法：例えば、どの画面コンテキストに返すか、画面間データ連携のプロトコル（Navigationパラメーター、コールバックなど）については後工程で調整が必要

---

## 9. 変更履歴

| 日付       | 変更内容               | 担当者 |
| ---------- | ---------------------- | ------ |
| 2025-05-16 | 初版リリース           | 廣澤  |