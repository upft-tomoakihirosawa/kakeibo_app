# 年間推移画面 設計書

---

## 1. ドキュメント管理

- 文書名: 年間推移画面 設計書  
- 作成者: 廣澤  
- 作成日: 2025-05-16  

---

## 2. 画面概要

- 画面名称: 年間推移画面  
- 目的・概要:  
  本画面は、ユーザーの過去1年間の収支推移を視覚的に表示することを目的とする。画面上では、選択された年度の各月毎の収支データおよび年間合計をグラフやリスト形式で表示し、ユーザーが家計の傾向を一目で把握できるようにする。また、年度の切替やデータの再読み込みを行うことで、異なる年度の分析も可能とする。

---

## 3. UIコンポーネント詳細

### コンポーネント一覧

| コンポーネント名         | 属性         | 機能・動作                                                        | 導出元                | 導出元項目             | 備考                                 |
| ------------------------ | ------------ | ----------------------------------------------------------------- | --------------------- | ---------------------- | ------------------------------------ |
| 年度選択スピナー         | スピナー     | ユーザーが表示対象の年度を選択。選択変更時にデータを再取得する       | Firebase Firestore    | availableYears         | 初期値は端末の日付により自動選択      |
| 年間グラフエリア         | コンテナ     | Chart.js等を用いて、選択年度の月別収支（収入・支出、差引）の推移グラフを描画する | Firebase Firestore    | annualSummary→monthlyData  | グラフは棒グラフまたは折れ線グラフで表示 |
| 月別収支リスト           | リスト表示   | 選択年度の各月の収支詳細（収入、支出、合計）をテキストおよび数値で表示。リスト項目をクリックすると月詳細画面へ遷移する | Firebase Firestore    | monthlyRecords→summary  | 月ごとの詳細画面へのリンクを含む       |
| 年間合計表示ラベル       | テキスト表示 | 選択年度の総収入、総支出、収支差額を表示                           | Firebase Firestore    | annualSummary→totalIncome,<br>annualSummary→totalExpense,<br>annualSummary→balance  | 数値フォーマット適用                 |
| 更新ボタン               | ボタン       | クリック時に最新の収支データを再取得し、グラフおよびリストを更新する    | －                    | －                     | API呼び出し前にローディング表示と連動    |
| 読込中表示エリア         | プログレスバー | データ取得中に画面上部またはグラフ内に読み込み中のインジケータを表示    | Firebase Firestore    | －                     | API通信時に表示                      |

---

## 4. 入力・出力項目

### 入力項目の詳細

本画面表示時に呼び出し元から渡されるデータは特に無し。  
※ユーザー認証後、内部的にユーザーIDはセッション管理されており、画面切替時はアプリ全体で保持される。

### 出力項目の詳細

本画面を終了する際に呼び出し元に返すデータは特に無し。  
※画面終了時の状態（表示年度、選択中の月詳細リンク情報等）は内部画面遷移で管理する。

---

## 5. イベント・アクション仕様

- 画面表示開始時の初期処理  
  1. 画面ロード時に「読込中表示エリア」を表示。  
  2. Firebase Firestoreからユーザーの利用可能な年度一覧（availableYears）を取得し、年度選択スピナーに反映。  
  3. 初期選択年度（通常は現在年度）における年間収支データ（annualSummary）および各月の詳細データ（monthlyRecords）を取得。  
  4. 取得後、グラフエリアおよび月別収支リストにデータを反映し、「読込中表示エリア」を非表示にする。

- 年度選択スピナー変更時の処理  
  1. ユーザーが別の年度を選択すると、該当年度の収支データを再取得する。  
  2. 取得成功後、グラフエリア、月別収支リスト、年間合計表示ラベルを更新する。

- 更新ボタン押下時の処理  
  1. ボタンクリックにより、強制的に最新の収支データをFirebase Firestoreから再取得する。  
  2. 再取得中は「読込中表示エリア」を表示し、完了後に画面コンポーネントを更新する。

- 月別収支リスト項目クリック時の処理  
  1. クリックされた月の詳細情報を保持し、月詳細画面へ遷移する。

- 画面終了時の処理  
  1. 現在の画面状態（選択年度等）は内部ルーティングにより管理され、特段の出力項目は返さない。

- 状態通知時の処理  
  1. API呼び出しエラーやDBエラー発生時には、ポップアップやスナックバーでエラーメッセージを表示する。  
  2. エラー発生後は、画面の再読込または更新ボタンで処理再試行可能とする。

---

## 6. バリデーションとエラーハンドリング

### バリデーションルール

| 項目名         | 制約条件                                      | チェック方法                     | 備考                             |
| -------------- | --------------------------------------------- | -------------------------------- | -------------------------------- |
| 年度（選択スピナー） | 必須、提供された選択肢の中から選ぶこと          | ドロップダウンの選択値検証          | ユーザーが直接入力することは無く、提供済みの選択肢のみ |
  
※本画面では直接のテキスト入力項目は存在しないため、基本的にユーザー操作は選択とクリックに限定される。

### エラーハンドリング

| エラーコード | エラーメッセージ                                   | 対処方法                            |
| ------------ | -------------------------------------------------- | ----------------------------------- |
| ERR100       | データの取得に失敗しました。ネットワーク状態をご確認ください。 | 更新ボタンによる再取得、または再読み込み |
| ERR101       | 選択された年度のデータが存在しません。                | 年度選択スピナーの選択肢を再確認または別の年度を選択 |
| ERR102       | 内部エラーが発生しました。                              | システム管理者へ連絡し、再度操作を試みる           |

---

## 7. 補足情報

- 外部連携・API  
  - Firebase Firestore: ユーザーの収支記録、年度別集計情報（annualSummary、monthlyRecords）の取得に使用する。  
  - 外部グラフライブラリ: Chart.jsまたはRechartsを利用してグラフ描画を行う。  

- 参考資料・用語集  
  - 家計簿アプリ全体の要件定義書（2025/05版）  
  - UIデザインガイドラインおよびUXベストプラクティス資料

---

## 8. 課題、検討、不明事項

- 年間収支データの取得件数が増加した場合のパフォーマンス検証と、適切なインデックスの設定が必要。  
- グラフの種類（棒グラフ、折れ線グラフ）の選定について、ユーザー調査の結果を踏まえて最適な表示方法を検討する必要がある。  
- 年度選択時のデフォルト値の決定（現在年度以外に過去年度の自動補完方法）が検討課題。  
- APIエラー発生時の詳細な再試行ロジックや、エラーログの蓄積方法について、バックエンドチームとの連携が必要。

---

## 9. 変更履歴

| 日付       | 変更内容               | 担当者  |
| ---------- | ---------------------- | ------- |
| 2025-05-16 | 初版リリース           | 廣澤  |