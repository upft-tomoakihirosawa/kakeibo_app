# クラウドバックアップ機能 設計書

---

## 1. ドキュメント管理

- 文書名: クラウドバックアップ機能 設計書  
- 作成者: 廣澤  
- 作成日: 2025-05-16  

---

## 2. 画面概要

- 画面名称: クラウドバックアップ設定画面  
- 目的・概要:  
  本画面は、ユーザーが家計簿アプリのデータをクラウド（Google Drive、iCloud など）にバックアップするための設定および操作を行うための画面です。ユーザーは画面上で利用するクラウドサービスを選択し、手動バックアップの開始や自動バックアップ機能のON/OFF切替、そして直近のバックアップ日時や進捗状況を確認できます。これにより、端末故障やデバイス変更時にも安心してデータを保持できる運用を実現します。

---

## 3. UIコンポーネント詳細

### コンポーネント一覧

| コンポーネント名             | 属性           | 機能・動作                                                                                                     | 導出元                   | 導出元項目                    | 備考                           |
| ---------------------------- | -------------- | -------------------------------------------------------------------------------------------------------------- | ------------------------ | ----------------------------- | ------------------------------ |
| クラウドサービス選択スピナー | スピナー       | 利用可能なクラウドサービス（例：Google Drive、iCloud）の一覧から、バックアップに利用するサービスを選択する。       | アプリ設定DB/API       | supportedServices             | デフォルトはリスト先頭の値     |
| バックアップ開始ボタン       | ボタン         | ユーザーが手動バックアップ処理を開始する。ボタン押下時、進捗バーの表示、状態ラベルの更新とAPI呼び出しを行う。         | －                       | －                            | ボタン押下中は無効化状態になる |
| バックアップ状態ラベル       | テキスト表示   | バックアップ処理の状態（「完了」「処理中」「失敗」など）を動的に表示する。                                          | バックアップAPI        | status                        | 状態に応じて色やアイコンを変更 |
| 進捗バー                     | プログレスバー | バックアップ処理の進捗（％）を視覚的に表示する。                                                              | バックアップAPI        | progress                      | 進行中のみ表示                |
| 自動バックアップ切替スイッチ | スイッチ       | 自動バックアップ機能のON/OFFを切り替える。切替時、ユーザー設定が更新され、今後の自動処理に反映される。              | ユーザー設定DB         | autoBackupEnabled             | 切替変更は即時反映             |
| 最終バックアップ日時ラベル   | テキスト表示   | 最後にバックアップが正常に完了した日時を表示する。                                                             | バックアップAPI        | lastBackupTimestamp           | 表示形式：YYYY-MM-DD HH:mm:ss  |
| 戻るボタン                   | ボタン         | ユーザー操作完了後、設定画面や前画面に戻るための処理を実行する。                                               | －                       | －                            | 画面終了処理をトリガー         |

---

## 4. 入力・出力項目

### 入力項目の詳細

本画面表示時に呼び出し元から特段のデータは渡されず、各設定は内部のユーザー設定DBおよびクラウドバックアップAPIから取得する。  
入力項目: 特に無し

### 出力項目の詳細

本画面終了時に呼び出し元へ返すデータはなく、各種設定変更は内部で保持・更新される。  
出力項目: 特に無し

---

## 5. イベント・アクション仕様

- 画面表示開始時の初期処理:  
  • ユーザーの自動バックアップ設定（自動バックアップ切替状態、前回バックアップ日時）をユーザー設定DBおよびバックアップAPIから取得し、各コンポーネントに反映する。  
  • 利用可能なクラウドサービスの一覧をアプリ設定DB/APIより取得し、クラウドサービス選択スピナーに設定する。  
  • バックアップが進行中の場合は進捗バーを表示し、状態ラベルを「処理中」と更新する。

- ユーザーアクション:  
  • バックアップ開始ボタン押下:  
  - 入力チェック（クラウドサービスが選択されていること）を行う。  
  - API呼び出しにより手動バックアップ処理を開始する。  
  - 呼び出し後、ボタンを無効化し、進捗バーおよび状態ラベルを更新する。  
  • 自動バックアップ切替スイッチの切替:  
  - 切替時に、直ちにユーザー設定DBへ更新要求を送信する。  
  - 更新成功後、確認メッセージを表示する。  
  • クラウドサービス選択スピナーの選択変更:  
  - 選択されたサービスを内部設定に反映し、必要に応じて連携認証のトリガーを実施する。  
  • 戻るボタン押下:  
  - 画面終了前に、未保存設定があれば最終確認ダイアログを表示。  
  - 確認後、前画面に戻る。

- 画面終了時の終了処理:  
  • 現在の設定状態（自動バックアップのON/OFF、選択したクラウドサービス）を最終保存し、ユーザー設定DBへ反映する。  
  • 進行中のバックアップ処理があれば、その中断または継続をユーザーに問い合わせる。

- 状態通知時の処理:  
  • バックアップAPIからのプッシュ通知（進捗更新、完了、失敗など）を受け取り、状態ラベルおよび進捗バーをリアルタイムで更新する。  
  • エラー発生時は、エラー用ダイアログを表示し、詳細なエラーメッセージと再試行オプションを提示する。

---

## 6. バリデーションとエラーハンドリング

### バリデーションルール

| 項目名               | 制約条件                                  | チェック方法                                | 備考                                               |
| -------------------- | ----------------------------------------- | ------------------------------------------- | -------------------------------------------------- |
| クラウドサービス選択 | 必須、有効なサービスが選択されていること   | スピナーの選択値が事前定義のリスト内にあるかチェック | 初期表示時はデフォルト値（リスト先頭）を設定する      |

※ 自動バックアップ切替やボタン押下については、特に入力形式上のバリデーションは不要。

### エラーハンドリング

| エラーコード | エラーメッセージ                                         | 対処方法                                               |
| ------------ | -------------------------------------------------------- | ------------------------------------------------------ |
| ERR101       | クラウドサービスが選択されていません。                   | 有効なクラウドサービスが選択されているか確認し、再度選択 |
| ERR102       | バックアップの開始に失敗しました。                       | 再試行を促し、ネットワーク状況および認証情報を確認する    |
| ERR103       | 自動バックアップ設定の更新に失敗しました。               | ユーザーにエラーメッセージを表示し、再度設定変更を促す     |
| ERR104       | バックアップ処理中にエラーが発生しました。               | 進捗バー・状態ラベルにエラー状態を表示し、詳細エラー内容をログ出力する |

---

## 7. 補足情報

- 外部連携・API:  
  • バックアップAPI  
  – エンドポイント例: /api/backup/start, /api/backup/status  
  – サンプルリクエスト/レスポンスで進捗や最終日時、状態情報を取得  
  • ユーザー設定DB/API  
  – 自動バックアップ設定（autoBackupEnabled）の取得・更新  
  • アプリ設定DB/API  
  – 利用可能なクラウドサービス（supportedServices）の一覧取得  
  • クラウドサービス連携:  
  – Google Drive SDK、iCloud連携用の各SDKを利用し、OAuth認証やトークン管理を実施

- 参考資料・用語集:  
  • 家計簿アプリ 要件定義書（バックアップ機能項目）  
  • 各クラウドサービスの連携ガイドライン  
  • UI設計・操作性に関する社内デザインガイドライン

---

## 8. 課題、検討、不明事項

- ネットワーク障害発生時のバックアップ処理の再開、または中断の取り扱いを検討する必要がある。  
- 複数プラットフォーム（モバイルとWeb）において、バックアップ処理の同期および表示タイミングの一貫性の確保。  
- クラウドサービス連携におけるOAuthトークンの有効期限管理と再認証フローの詳細設計。  
- バックアップ進捗のリアルタイム更新に伴うUIアニメーションやユーザー操作との競合処理について、追加検証が必要。  

---

## 9. 変更履歴

| 日付       | 変更内容                | 担当者 |
| ---------- | ----------------------- | ------ |
| 2025-05-16 | 初版リリース            | 廣澤  |