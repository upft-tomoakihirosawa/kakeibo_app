# 設定画面 設計書

---

## 1. ドキュメント管理

- 文書名: 設定画面 設計書  
- 作成者: 廣澤  
- 作成日: 2025-05-16  

---

## 2. 画面概要

- 画面名称: 設定画面  
- 目的・概要:  
  本画面は、家計簿アプリ利用者が自身のアカウント情報、通知設定、カテゴリ管理、クラウドバックアップの連携状態、及びアプリ情報を確認・変更するための画面です。利用者はアカウントのセキュリティ更新や、毎日の利用に関わる通知のON/OFF、各種設定のカスタマイズを直感的に操作でき、アプリとの連携や利用状況の把握が容易になることを目的とします。

---

## 3. UIコンポーネント詳細

### コンポーネント一覧

| コンポーネント名             | 属性           | 機能・動作                                                                                                                                              | 導出元                 | 導出元項目                  | 備考                                 |
| ---------------------------- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | --------------------------- | ------------------------------------ |
| アカウント情報エリア         | コンテナ       | 現在ログイン中のユーザーのメールアドレス、ユーザー名、アイコン等の情報を表示。                                                                           | Firebase Auth / DB     | email, userName, iconURL    | ユーザー認証情報を表示               |
| パスワード変更ボタン         | ボタン         | クリック時、パスワード変更画面へ遷移。                                                                                                                    | －                     | －                          | セキュリティ設定へのリンク           |
| SNS連携管理ボタン           | ボタン         | クリック時、SNS連携状況の確認・変更画面へ遷移（連携中のSNSの解除や追加）。                                                                              | Firebase Auth         | linkedSNS                   | SNS認証連携の状態を反映              |
| 通知設定スイッチ             | トグルスイッチ | 通知設定（入力忘れ防止通知、予算超過アラート）のON/OFF切替。トグル切替時、即時に変更状態がAPI経由で保存され、最新の状態が反映される。                              | ユーザー設定DB         | pushNotificationFlag        | リアルタイム更新、ユーザー設定反映    |
| カテゴリ管理ボタン           | ボタン         | クリック時、ユーザー独自のカテゴリの追加・編集・削除を行うカテゴリ管理画面へ遷移。                                                                          | －                     | －                          | カテゴリカスタマイズへのリンク       |
| クラウドバックアップ設定ボタン | ボタン         | クリック時、クラウドバックアップ（Google Drive / iCloud等）の連携状態確認及び設定変更画面へ遷移。                                                           | バックアップ設定API    | backupStatus                | 連携状態により表示内容が変更         |
| アプリ情報エリア             | コンテナ       | 現在のアプリバージョン、利用規約へのリンク、プライバシーポリシー等の情報を表示。                                                                         | config API             | appVersion, termsURL        | 固定情報またはAPIから動的に取得       |

---

## 4. 入力・出力項目

### 入力項目の詳細

画面表示時に呼び出し元から受け取るデータ項目は以下とする。

| 項目名 | 入力形式 | 入力制約 | エラーメッセージ例 |
| ------ | -------- | -------- | ------------------ |
| 特に無し | －       | －       | －                 |

### 出力項目の詳細

画面終了時に呼び出し元にデータを返す項目は以下とする。

| 項目名   | 内容                                     |
| -------- | ---------------------------------------- |
| 特に無し | －                                       |

---

## 5. イベント・アクション仕様

- 画面表示開始時の初期処理  
  • ユーザーのアカウント情報（メールアドレス、ユーザー名、アイコン）をFirebase AuthおよびユーザーDBから取得し、アカウント情報エリアへ反映。  
  • 通知設定、クラウドバックアップの連携状態をユーザー設定DBおよびバックアップ設定APIから取得し、各スイッチ・ボタンの状態を設定。  
  • アプリ情報（バージョン情報、利用規約リンク等）をconfig APIから取得して表示。  

- 画面上でのアクションイベント  
  • 【パスワード変更ボタン】: クリック時にパスワード変更画面へ遷移。  
  • 【SNS連携管理ボタン】: クリック時にSNS連携状況の確認・変更画面へ遷移。  
  • 【通知設定スイッチ】: ON/OFF切替時、トグルの状態をユーザー設定DBに即時保存するAPIを呼び出し、成功/失敗によって画面上にフィードバック（例：Toast表示）を実施。  
  • 【カテゴリ管理ボタン】: クリック時にカテゴリ管理画面へ遷移。  
  • 【クラウドバックアップ設定ボタン】: クリック時にバックアップ設定画面へ遷移し、連携状態の確認及び設定変更が可能。  

- 画面終了時の処理  
  • 入力された設定内容が未保存の場合、変更内容の再確認・保存を促すダイアログを表示。  
  • 画面終了時、最新の設定状態（特に通知設定等）が確実にDBに反映されていることを確認するため、APIからのレスポンス内容を最終チェックする。

---

## 6. バリデーションとエラーハンドリング

### バリデーションルール

| 項目名         | 制約条件                                      | チェック方法                       | 備考                                     |
| -------------- | --------------------------------------------- | ---------------------------------- | ---------------------------------------- |
| 通知設定スイッチ | 必ずONまたはOFFの状態。値が不正な場合はデフォルトOFFとして扱う。 | スイッチの状態の確認・APIレスポンスチェック | API更新時に不具合がある場合のフォールバック処理実施 |
| クラウドバックアップ連携 | 連携状態の値が true/false のいずれかであること。                         | APIレスポンスの型チェック             | 連携状態取得時に不正値の場合は、再取得を促す       |

### エラーハンドリング

| エラーコード | エラーメッセージ                                                | 対処方法                                        |
| ------------ | --------------------------------------------------------------- | ----------------------------------------------- |
| ERR101       | ユーザー情報の取得に失敗しました。再度ログインしてください。      | ログイン画面へ誘導し、再認証を促す               |
| ERR102       | 通知設定の更新に失敗しました。通信環境を確認の上、再度お試しください。 | スイッチ状態を前回の値に戻し、エラートースト表示   |
| ERR103       | クラウドバックアップ連携状態の取得に失敗しました。              | 再度連携状態の取得を試み、状況に応じてエラーメッセージ表示 |
| ERR104       | アプリ情報の取得に失敗しました。                                | 固定値またはキャッシュされたデータを一時的に表示    |

---

## 7. 補足情報

- 外部連携・API  
  • Firebase Auth API: ユーザー認証情報の取得および更新。  
  • ユーザー設定DB（Firestore等）: 通知設定、その他ユーザー設定の管理。  
  • バックアップ設定API: クラウドバックアップの連携状態管理。  
  • config API: アプリバージョン、利用規約、プライバシーポリシー等の固定情報取得。  

- 参考資料・用語集  
  • Firebase Documentation  
  • REST API設計ガイドライン  
  • UIコンポーネント設計仕様書（共通設計ガイド）

---

## 8. 課題、検討、不明事項

- 各設定変更時のAPIレスポンス遅延やタイムアウト発生時のユーザーへのフィードバック方法（ローディング表示やretryの仕組み）の詳細な検討が必要。  
- SNS連携管理における各SNSプロバイダ（Google, Facebook, Twitter等）の連携解除・再連携処理の統一仕様の設計。  
- モバイル（iOS／Android）とWeb間でのUI表現やアニメーションの動作差異の検証、統一化の検討。  
- 通知設定変更後、即時反映されない場合の同期エラー処理やユーザー通知方法の詳細検討。

---

## 9. 変更履歴

| 日付       | 変更内容                | 担当者  |
| ---------- | ----------------------- | ------- |
| 2025-05-16 | 初版リリース            | 廣澤   |